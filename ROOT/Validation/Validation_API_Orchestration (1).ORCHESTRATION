{"job":{"components":{"63788":{"id":63788,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":208,"y":-48,"width":32,"height":32,"inputConnectorIDs":[63793],"outputSuccessConnectorIDs":[63794],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Extract Jobs from Task History"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import requests\nfrom requests.auth import HTTPBasicAuth\nimport json\nimport os\n\nfrom azure.keyvault.secrets import SecretClient\nfrom azure.identity import DefaultAzureCredential\nfrom azure.storage.blob import BlobServiceClient\n\n# Acquire a credential object\ntoken_credential = DefaultAzureCredential()\n\nsecret_client = SecretClient(vault_url=\"https://MatillionDevQAKeyVault.vault.azure.net/\", credential=token_credential)\n\ninstance = secret_client.get_secret(\"INSTANCE\")\nuser = secret_client.get_secret(\"MAT-USER\")\npw = secret_client.get_secret(\"MAT-PW\")\n\nall_jobs = requests.get(f\"https://{instance.value}/rest/v1/group/name/{project_group_name}/project/name/{project_name}/task/id/{run_history_id}\", auth=HTTPBasicAuth(f'{user.value}', f'{pw.value}'), verify = False).content\njob_json = json.loads(all_jobs)\n\njob_list = job_json['jobNames']\n\n\njob_set = list(set(job_list))\njob_set = ','.join(map(str, job_set))\njob_set = f'\"{job_set}\"'\ncontext.updateVariable(\"running_jobs\", job_set)\n"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"63789":{"id":63789,"inputCardinality":"ZERO","outputCardinality":"MANY","connectorHint":"UNCONDITIONAL","executionHint":"FLOW","implementationID":444132438,"x":-48,"y":0,"width":32,"height":32,"inputConnectorIDs":[],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[63795],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Start","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Start 0"}}}},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"63790":{"id":63790,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"TRANSFORM","implementationID":1785813072,"x":96,"y":0,"width":32,"height":32,"inputConnectorIDs":[63795],"outputSuccessConnectorIDs":[63793],"outputFailureConnectorIDs":[63796],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Master-Orchestration-Job"}}}},"visible":true},"2":{"slot":2,"name":"Orchestration Job","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"${current_job}"}}}},"visible":true},"3":{"slot":3,"name":"","elements":{},"visible":false},"4":{"slot":4,"name":"Set Scalar Variables","elements":{},"visible":true},"5":{"slot":5,"name":"Set Grid Variables","elements":{},"visible":true}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"63791":{"id":63791,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":352,"y":-48,"width":32,"height":32,"inputConnectorIDs":[63794],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python Script 0"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import os\nfrom azure.keyvault.secrets import SecretClient\nfrom azure.identity import DefaultAzureCredential\nfrom azure.storage.blob import BlobServiceClient\n\n# Acquire a credential object\ntoken_credential = DefaultAzureCredential()\n\nsecret_client = SecretClient(vault_url=\"https://MatillionDevQAKeyVault.vault.azure.net/\", credential=token_credential)\n\nuser = secret_client.get_secret(\"AZ-USER\")\npw = secret_client.get_secret(\"KEY\")\n\nos.system(f\"\"\"\ncurl -X POST -u '{user.value}':'{pw.value}' https://dev.azure.com/Curaleaf/Matillion%20Integration/_apis/pipelines/233/runs?api-version=6.0-preview.1 -H \"Content-Type: application/json\" -d '{{ \"resources\": {{ \"repositories\": {{ \"self\": {{ \"refName\": \"refs/heads/develop\" }}}}}}, \"variables\": {{\"Current_Feature\": {{\"value\": \"'\"{current_feature}\"'\"}}, \"Job_List\": {{\"value\": \"'{running_jobs}'\"}}, \"QA_Jobs\": {{\"value\": \"'{qa_jobs}'\"}}, \"API_Call\": {{\"value\": \"true\"}}, \"Job_Status\": {{\"value\": \"succeeded\"}}, \"branch\": {{\"value\": \"feature_'\"{version_name}\"'\"}}, \"Group\": {{\"value\": \"'\"{project_group_name}\"'\"}}, \"Project\": {{\"value\": \"'\"{project_name}\"'\"}}, \"Version\": {{\"value\": \"'\"{version_name}\"'\"}}, \"Job\": {{\"value\": \"'\"{job_name}\"'\"}}, \"Top_Level_Job\": {{\"value\": \"'\"{current_job}\"'\"}}, \"ENV\": {{\"value\": \"'\"{environment_name}\"'\"}}}}}}'\n\"\"\")"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]},"63792":{"id":63792,"inputCardinality":"ONE","outputCardinality":"MANY","connectorHint":"SUCCESS_FAIL","executionHint":"EXECUTE","implementationID":-1773186829,"x":352,"y":80,"width":32,"height":32,"inputConnectorIDs":[63796],"outputSuccessConnectorIDs":[],"outputFailureConnectorIDs":[],"outputUnconditionalConnectorIDs":[],"outputTrueConnectorIDs":[],"outputFalseConnectorIDs":[],"exportMappings":{},"parameters":{"1":{"slot":1,"name":"Name","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python Script 1"}}}},"visible":true},"2":{"slot":2,"name":"Script","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"import os\nfrom azure.keyvault.secrets import SecretClient\nfrom azure.identity import DefaultAzureCredential\nfrom azure.storage.blob import BlobServiceClient\n\n# Acquire a credential object\ntoken_credential = DefaultAzureCredential()\n\nsecret_client = SecretClient(vault_url=\"https://CICD-Matillion-Keys.vault.azure.net/\", credential=token_credential)\n\nuser = secret_client.get_secret(\"USER\")\npw = secret_client.get_secret(\"KEY\")\n\nos.system(f\"\"\"\ncurl -X POST -u '{user.value}':'{pw.value}' https://dev.azure.com/CICD-Roadshow/Roadshow_Matillion_CICD/_apis/pipelines/1/runs?api-version=6.0-preview.1 -H \"Content-Type: application/json\" -d '{{ \"resources\": {{ \"repositories\": {{ \"self\": {{ \"refName\": \"refs/heads/develop\" }}}}}}, \"variables\": {{\"Current_Feature\": {{\"value\": \"'\"{current_feature}\"'\"}}, \"Job_List\": {{\"value\": \"'{running_jobs}'\"}}, \"QA_Jobs\": {{\"value\": \"'{qa_jobs}'\"}}, \"API_Call\": {{\"value\": \"true\"}}, \"Job_Status\": {{\"value\": \"failed\"}}, \"branch\": {{\"value\": \"feature_'\"{version_name}\"'\"}}, \"Group\": {{\"value\": \"'\"{project_group_name}\"'\"}}, \"Project\": {{\"value\": \"'\"{project_name}\"'\"}}, \"Version\": {{\"value\": \"'\"{version_name}\"'\"}}, \"Job\": {{\"value\": \"'\"{job_name}\"'\"}}, \"Top_Level_Job\": {{\"value\": \"'\"{current_job}\"'\"}}, \"ENV\": {{\"value\": \"'\"{environment_name}\"'\"}}}}}}'\n\"\"\")"}}}},"visible":true},"3":{"slot":3,"name":"Interpreter","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Python 3"}}}},"visible":true},"4":{"slot":4,"name":"Timeout","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"INTEGER","value":"360"}}}},"visible":true},"5":{"slot":5,"name":"User","elements":{"1":{"slot":1,"values":{"1":{"slot":1,"type":"STRING","value":"Restricted"}}}},"visible":false}},"expectedFailure":null,"activationStatus":"ENABLED","outputIterationConnectorIDs":[],"inputIterationConnectorIDs":[]}},"successConnectors":{"63793":{"id":63793,"sourceID":63790,"targetID":63788},"63794":{"id":63794,"sourceID":63788,"targetID":63791}},"failureConnectors":{"63796":{"id":63796,"sourceID":63790,"targetID":63792}},"unconditionalConnectors":{"63795":{"id":63795,"sourceID":63789,"targetID":63790}},"trueConnectors":{},"falseConnectors":{},"iterationConnectors":{},"noteConnectors":{},"notes":{"63787":{"id":63787,"x":-80,"y":-191,"width":496,"height":96,"text":"**Matillion CICD Code Promotion Orchestration**\n\nEnsure you are in the **DEV** Project\nEnsure you are **NOT** in the **default** Version\nEnsure you are in your individual developer Environment and **NOT** in the **DEV** Environment\nEnsure the current_job Environment Variable is populated for your individual developer / Environment with the value of the top level Orchestration of the process you want to test","colour":"e6e63c"}},"variables":{"JOB_NAME":{"definition":{"name":"JOB_NAME","type":"TEXT","scope":"BRANCH","description":"","visibility":"PUBLIC"},"value":""}},"grids":{}},"info":{"name":"Validation_API_Orchestration (1)","description":"","type":"ORCHESTRATION","tag":"65e8f9f2-2ef8-421f-a926-f1136b681ab3"}}